<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Riscos Psicossociais - NR-1/NR-17 | RC Engenharia</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .nivel-critico { background-color: #fadbd8; color: #922b21; }
        .nivel-alto { background-color: #fdebd0; color: #9c640c; }
        .nivel-moderado { background-color: #fcf3cf; color: #9a7b0a; }
        .nivel-baixo { background-color: #d5f5e3; color: #1e8449; }
        .hidden { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Navbar -->
<nav class="gradient-bg text-white shadow-lg no-print">
    <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="mostrarTela('inicio')">
                <i class="fas fa-brain text-2xl"></i>
                <div>
                    <h1 class="text-lg font-bold">RC Engenharia</h1>
                    <p class="text-xs opacity-75">Riscos Psicossociais | NR-1 / NR-17</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="mostrarTela('inicio')" class="hover:bg-white/10 px-3 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-home mr-1"></i> Início
                </button>
                <button onclick="mostrarTela('historico')" class="hover:bg-white/10 px-3 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-history mr-1"></i> Histórico
                </button>
                <button onclick="exportarBackup()" class="hover:bg-white/10 px-3 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-download mr-1"></i> Backup
                </button>
                <button onclick="importarBackup()" class="hover:bg-white/10 px-3 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-upload mr-1"></i> Restaurar
                </button>
                <input type="file" id="input-backup" accept=".json" class="hidden" onchange="processarBackup(event)">
            </div>
        </div>
    </div>
</nav>

<!-- Container Principal -->
<main class="max-w-6xl mx-auto px-4 py-6">

    <!-- TELA: INÍCIO -->
    <div id="tela-inicio">
        <!-- Hero -->
        <div class="gradient-bg rounded-2xl shadow-xl p-8 mb-8 text-white">
            <div class="max-w-3xl">
                <h1 class="text-3xl font-bold mb-4">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Avaliação de Riscos Psicossociais
                </h1>
                <p class="text-lg opacity-90 mb-6">
                    Sistema integrado para avaliação de fatores de riscos psicossociais conforme 
                    NR-1 (GRO) e NR-17 (Ergonomia) - Portaria MTE nº 1.419/2024.
                </p>
                <button onclick="mostrarTela('empresa')" class="bg-white text-blue-800 hover:bg-blue-50 px-6 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-play mr-2"></i> Iniciar Nova Avaliação
                </button>
            </div>
        </div>

        <!-- Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow p-6 text-center card-hover transition">
                <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-layer-group text-2xl text-blue-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800">7 Dimensões</h3>
                <p class="text-sm text-gray-500">HSE Standards</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center card-hover transition">
                <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-question-circle text-2xl text-green-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800">39 Questões</h3>
                <p class="text-sm text-gray-500">Validadas</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center card-hover transition">
                <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-pdf text-2xl text-purple-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800">Relatório PDF</h3>
                <p class="text-sm text-gray-500">Automático</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center card-hover transition">
                <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-excel text-2xl text-orange-600"></i>
                </div>
                <h3 class="font-semibold text-gray-800">Export Excel</h3>
                <p class="text-sm text-gray-500">Dados completos</p>
            </div>
        </div>

        <!-- Metodologias -->
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-6">
            <h3 class="font-semibold text-amber-800 mb-4">
                <i class="fas fa-book mr-2"></i> Metodologias Integradas
            </h3>
            <div class="grid md:grid-cols-3 gap-4 text-sm text-amber-700">
                <div><i class="fas fa-check-circle mr-1"></i> HSE Management Standards (UK)</div>
                <div><i class="fas fa-check-circle mr-1"></i> Job Stress Scale (Karasek)</div>
                <div><i class="fas fa-check-circle mr-1"></i> ISO 45003:2021</div>
                <div><i class="fas fa-check-circle mr-1"></i> NR-1 / NR-17 (Brasil)</div>
                <div><i class="fas fa-check-circle mr-1"></i> Guia MTE 2025</div>
                <div><i class="fas fa-check-circle mr-1"></i> Resolução CFP nº 14/2023</div>
            </div>
        </div>
    </div>

    <!-- TELA: CADASTRO EMPRESA -->
    <div id="tela-empresa" class="hidden">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="gradient-bg px-6 py-4">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-building mr-2"></i>
                        Dados da Empresa / Setor
                    </h2>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Empresa / Razão Social *</label>
                        <input type="text" id="empresa-nome" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Nome da empresa">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                            <input type="text" id="empresa-cnpj"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="00.000.000/0000-00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Setor / Área Avaliada *</label>
                            <input type="text" id="empresa-setor" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Ex: Administrativo">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Responsável Técnico</label>
                            <input type="text" id="empresa-responsavel"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Nome completo">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Função do Responsável</label>
                            <input type="text" id="empresa-funcao"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Ex: Engenheiro de Segurança">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Registro Profissional</label>
                            <input type="text" id="empresa-registro"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="CREA, CRP, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data da Avaliação *</label>
                            <input type="date" id="empresa-data" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button onclick="mostrarTela('inicio')" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </button>
                        <button onclick="salvarEmpresa()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition">
                            Próximo <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA: PARTICIPANTES -->
    <div id="tela-participantes" class="hidden">
        <div class="max-w-3xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-users mr-2 text-blue-600"></i>
                    Participantes da Avaliação
                </h2>
                <p class="text-gray-600 text-sm mb-4">
                    Empresa: <strong id="info-empresa"></strong> | Setor: <strong id="info-setor"></strong>
                </p>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-blue-800 text-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        Clique em "Aplicar Questionário" para cada participante responder. As respostas são anônimas.
                    </p>
                </div>
                
                <div id="lista-participantes" class="mb-6"></div>
                
                <button onclick="iniciarQuestionario()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 rounded-xl transition text-lg">
                    <i class="fas fa-plus-circle mr-2"></i> Aplicar Questionário (Novo Participante)
                </button>
            </div>
            
            <div class="flex gap-4">
                <button onclick="mostrarTela('empresa')" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-lg transition">
                    <i class="fas fa-arrow-left mr-2"></i> Voltar
                </button>
                <button onclick="verResultados()" id="btn-resultados" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition disabled:bg-gray-400" disabled>
                    <i class="fas fa-chart-bar mr-2"></i> Ver Resultados
                </button>
            </div>
        </div>
    </div>

    <!-- TELA: QUESTIONÁRIO -->
    <div id="tela-questionario" class="hidden">
        <div class="max-w-3xl mx-auto">
            <!-- Barra de Progresso -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Questão <span id="questao-atual">1</span> de 39</span>
                    <span><span id="progresso-pct">0</span>% concluído</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="barra-progresso" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Dimensão Atual -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <span id="dimensao-badge" class="text-sm font-semibold px-3 py-1 rounded-full"></span>
            </div>
            
            <!-- Questão -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <p id="questao-texto" class="text-lg text-gray-800 mb-6"></p>
                
                <div id="opcoes-resposta" class="space-y-3"></div>
            </div>
            
            <!-- Navegação -->
            <div class="flex gap-4">
                <button onclick="questaoAnterior()" id="btn-anterior" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-lg transition hidden">
                    <i class="fas fa-arrow-left mr-2"></i> Anterior
                </button>
                <button onclick="finalizarQuestionario()" id="btn-finalizar" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition hidden">
                    <i class="fas fa-check mr-2"></i> Finalizar
                </button>
            </div>
        </div>
    </div>

    <!-- TELA: HISTÓRICO -->
    <div id="tela-historico" class="hidden">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="gradient-bg px-6 py-4">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-history mr-2"></i>
                    Histórico de Avaliações
                </h2>
            </div>
            
            <div class="p-6">
                <!-- Filtro por empresa -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Empresa:</label>
                    <select id="filtro-empresa" onchange="filtrarHistorico()" class="w-full md:w-1/2 border border-gray-300 rounded-lg px-4 py-2">
                        <option value="">Todas as empresas</option>
                    </select>
                </div>
                
                <div id="lista-historico"></div>
            </div>
        </div>
        
        <div class="mt-6">
            <button onclick="mostrarTela('inicio')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition">
                <i class="fas fa-arrow-left mr-2"></i> Voltar ao Início
            </button>
        </div>
    </div>

    <!-- TELA: RESULTADOS -->
    <div id="tela-resultados" class="hidden">
        <!-- Header -->
        <div class="gradient-bg rounded-xl shadow-lg p-6 mb-6 text-white">
            <h1 class="text-2xl font-bold mb-2">
                <i class="fas fa-chart-bar mr-2"></i>
                Relatório de Avaliação de Riscos Psicossociais
            </h1>
            <p class="opacity-90">Conforme NR-1 (GRO) e NR-17 (Ergonomia) - Portaria MTE nº 1.419/2024</p>
        </div>
        
        <!-- Dados da Avaliação -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-building mr-2 text-blue-600"></i>
                Dados da Avaliação
            </h2>
            <div id="dados-avaliacao" class="grid md:grid-cols-2 gap-4 text-sm"></div>
        </div>
        
        <!-- Resultado Geral -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-tachometer-alt mr-2 text-blue-600"></i>
                Resultado Geral
            </h2>
            <div id="resultado-geral" class="flex flex-col md:flex-row items-center gap-6"></div>
        </div>
        
        <!-- Gráfico de Barras -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
                Escores por Dimensão
            </h2>
            <div class="h-80">
                <canvas id="grafico-barras"></canvas>
            </div>
        </div>
        
        <!-- Gráfico Radar -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-spider mr-2 text-blue-600"></i>
                Perfil de Riscos
            </h2>
            <div class="h-80">
                <canvas id="grafico-radar"></canvas>
            </div>
        </div>
        
        <!-- Tabela Detalhada -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="gradient-bg px-6 py-4">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-list-alt mr-2"></i>
                    Detalhamento por Dimensão
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="tabela-resultados">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-4 text-left font-semibold">Dimensão</th>
                            <th class="p-4 text-center font-semibold">Escore</th>
                            <th class="p-4 text-center font-semibold">Nível</th>
                            <th class="p-4 text-left font-semibold">Ação Recomendada</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-resultados"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Plano de Ação -->
        <div id="plano-acao" class="bg-white rounded-xl shadow-lg p-6 mb-6"></div>
        
        <!-- Cronograma -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
                Cronograma Sugerido
            </h2>
            <div class="space-y-3">
                <div class="flex items-center gap-4 p-3 rounded-lg nivel-critico">
                    <span class="font-bold w-28">IMEDIATA</span>
                    <span class="font-semibold">Até 30 dias</span>
                    <span class="flex-1">Dimensões em nível CRÍTICO</span>
                </div>
                <div class="flex items-center gap-4 p-3 rounded-lg nivel-alto">
                    <span class="font-bold w-28">ALTA</span>
                    <span class="font-semibold">Até 90 dias</span>
                    <span class="flex-1">Dimensões em nível ALTO</span>
                </div>
                <div class="flex items-center gap-4 p-3 rounded-lg nivel-moderado">
                    <span class="font-bold w-28">MÉDIA</span>
                    <span class="font-semibold">Até 180 dias</span>
                    <span class="flex-1">Dimensões em nível MODERADO</span>
                </div>
                <div class="flex items-center gap-4 p-3 rounded-lg nivel-baixo">
                    <span class="font-bold w-28">CONTÍNUA</span>
                    <span class="font-semibold">Permanente</span>
                    <span class="flex-1">Monitoramento e melhoria contínua</span>
                </div>
            </div>
        </div>
        
        <!-- Referências -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-book mr-2 text-blue-600"></i>
                Referências Normativas
            </h2>
            <ul class="text-sm text-gray-600 space-y-1">
                <li>• BRASIL. MTE. NR-1 - Disposições Gerais e GRO. Portaria MTE nº 1.419/2024.</li>
                <li>• BRASIL. MTE. NR-17 - Ergonomia.</li>
                <li>• BRASIL. MTE. Guia sobre Fatores de Riscos Psicossociais. 2025.</li>
                <li>• HSE. Managing the causes of work-related stress. London, 2007.</li>
                <li>• ISO 45003:2021 - Psychological health and safety at work.</li>
                <li>• KARASEK, R.A.; THEORELL, T. Healthy work. Basic Books, 1990.</li>
            </ul>
        </div>
        
        <!-- Botões de Ação -->
        <div class="grid md:grid-cols-4 gap-4 mb-6 no-print">
            <button onclick="mostrarTela('participantes')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-4 rounded-xl transition font-semibold">
                <i class="fas fa-arrow-left mr-2"></i> Voltar
            </button>
            <button onclick="gerarPDF()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-4 rounded-xl transition font-semibold">
                <i class="fas fa-file-pdf mr-2"></i> Baixar PDF
            </button>
            <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl transition font-semibold">
                <i class="fas fa-file-excel mr-2"></i> Exportar Excel
            </button>
            <button onclick="salvarNoHistorico()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-xl transition font-semibold">
                <i class="fas fa-save mr-2"></i> Salvar no Histórico
            </button>
        </div>
    </div>

</main>

<!-- Footer -->
<footer class="bg-gray-800 text-white mt-12 py-6 no-print">
    <div class="max-w-6xl mx-auto px-4 text-center">
        <p class="text-sm opacity-75">
            Sistema de Avaliação de Riscos Psicossociais | Conforme NR-1 (GRO) e NR-17 | Portaria MTE nº 1.419/2024
        </p>
        <p class="text-xs opacity-50 mt-2">
            © 2025 RC Engenharia - Serviços de Segurança e Saúde Ocupacional. Todos os direitos reservados.
        </p>
    </div>
</footer>

<script>
// ============================================================================
// DADOS DO QUESTIONÁRIO
// ============================================================================

const DIMENSOES = {
    demandas: { nome: 'Demandas do Trabalho', descricao: 'Carga de trabalho, ritmo, pressão temporal', questoes: [1,2,3,4,5,6,7,8], invertida: true, cor: '#e74c3c' },
    controle: { nome: 'Controle/Autonomia', descricao: 'Autonomia, participação em decisões', questoes: [9,10,11,12,13,14], invertida: false, cor: '#3498db' },
    apoioGerencial: { nome: 'Apoio da Gestão', descricao: 'Suporte de superiores, feedback', questoes: [15,16,17,18,19], invertida: false, cor: '#9b59b6' },
    apoioColegas: { nome: 'Apoio dos Colegas', descricao: 'Colaboração, clima organizacional', questoes: [20,21,22,23,24], invertida: false, cor: '#1abc9c' },
    relacionamentos: { nome: 'Relacionamentos', descricao: 'Conflitos, assédio, comportamentos', questoes: [25,26,27,28,29], invertida: true, cor: '#e67e22' },
    funcao: { nome: 'Clareza de Função', descricao: 'Papel, expectativas, responsabilidades', questoes: [30,31,32,33,34], invertida: false, cor: '#2ecc71' },
    mudancas: { nome: 'Gestão de Mudanças', descricao: 'Comunicação sobre mudanças', questoes: [35,36,37,38,39], invertida: false, cor: '#f39c12' }
};

const QUESTOES = [
    { id: 1, texto: 'Diferentes grupos/pessoas no trabalho exigem de mim coisas difíceis de conciliar.', dimensao: 'demandas' },
    { id: 2, texto: 'Tenho prazos impossíveis de cumprir.', dimensao: 'demandas' },
    { id: 3, texto: 'Preciso trabalhar muito intensamente.', dimensao: 'demandas' },
    { id: 4, texto: 'Preciso negligenciar algumas tarefas porque tenho muito o que fazer.', dimensao: 'demandas' },
    { id: 5, texto: 'Sou incapaz de fazer pausas suficientes.', dimensao: 'demandas' },
    { id: 6, texto: 'Sou pressionado(a) a trabalhar além do horário.', dimensao: 'demandas' },
    { id: 7, texto: 'Preciso trabalhar muito rápido.', dimensao: 'demandas' },
    { id: 8, texto: 'Tenho metas de trabalho irrealistas.', dimensao: 'demandas' },
    { id: 9, texto: 'Posso decidir quando fazer uma pausa.', dimensao: 'controle' },
    { id: 10, texto: 'Tenho voz ativa sobre meu ritmo de trabalho.', dimensao: 'controle' },
    { id: 11, texto: 'Tenho liberdade para escolher como realizar meu trabalho.', dimensao: 'controle' },
    { id: 12, texto: 'Tenho voz ativa sobre o que acontece no meu trabalho.', dimensao: 'controle' },
    { id: 13, texto: 'Minha jornada de trabalho pode ser flexível.', dimensao: 'controle' },
    { id: 14, texto: 'Posso decidir o que fazer no meu trabalho.', dimensao: 'controle' },
    { id: 15, texto: 'Posso contar com meu(minha) gestor(a) para me ajudar com problemas de trabalho.', dimensao: 'apoioGerencial' },
    { id: 16, texto: 'Recebo feedback útil do(a) meu(minha) gestor(a) sobre o trabalho que faço.', dimensao: 'apoioGerencial' },
    { id: 17, texto: 'Posso conversar com meu(minha) gestor(a) sobre algo que me chateou no trabalho.', dimensao: 'apoioGerencial' },
    { id: 18, texto: 'Sou apoiado(a) em trabalhos emocionalmente exigentes.', dimensao: 'apoioGerencial' },
    { id: 19, texto: 'Meu(minha) gestor(a) me encoraja no trabalho.', dimensao: 'apoioGerencial' },
    { id: 20, texto: 'Meus colegas de trabalho me ajudam e apoiam quando necessário.', dimensao: 'apoioColegas' },
    { id: 21, texto: 'Recebo o respeito que mereço dos meus colegas de trabalho.', dimensao: 'apoioColegas' },
    { id: 22, texto: 'Meus colegas estão dispostos a ouvir meus problemas de trabalho.', dimensao: 'apoioColegas' },
    { id: 23, texto: 'Existe um bom clima de colaboração na minha equipe de trabalho.', dimensao: 'apoioColegas' },
    { id: 24, texto: 'Tenho bom relacionamento com meus colegas de trabalho.', dimensao: 'apoioColegas' },
    { id: 25, texto: 'Existem atritos ou conflitos entre colegas na minha área de trabalho.', dimensao: 'relacionamentos' },
    { id: 26, texto: 'Sofro assédio, na forma de palavras ou comportamento ofensivo.', dimensao: 'relacionamentos' },
    { id: 27, texto: 'Existem situações de intimidação no meu ambiente de trabalho.', dimensao: 'relacionamentos' },
    { id: 28, texto: 'Os relacionamentos no meu ambiente de trabalho são tensos.', dimensao: 'relacionamentos' },
    { id: 29, texto: 'Há fofocas e rumores que prejudicam o ambiente de trabalho.', dimensao: 'relacionamentos' },
    { id: 30, texto: 'Sei claramente o que é esperado de mim no trabalho.', dimensao: 'funcao' },
    { id: 31, texto: 'Sei como fazer para cumprir as responsabilidades do meu trabalho.', dimensao: 'funcao' },
    { id: 32, texto: 'Tenho clareza sobre meus deveres e responsabilidades.', dimensao: 'funcao' },
    { id: 33, texto: 'Sei quais são os objetivos e metas do meu trabalho.', dimensao: 'funcao' },
    { id: 34, texto: 'Entendo como meu trabalho se encaixa nos objetivos da organização.', dimensao: 'funcao' },
    { id: 35, texto: 'Tenho oportunidades de questionar gestores sobre mudanças no trabalho.', dimensao: 'mudancas' },
    { id: 36, texto: 'Os funcionários são sempre consultados sobre mudanças no trabalho.', dimensao: 'mudancas' },
    { id: 37, texto: 'Quando ocorrem mudanças, sei como elas vão funcionar na prática.', dimensao: 'mudancas' },
    { id: 38, texto: 'Sou informado(a) com antecedência sobre mudanças que afetam meu trabalho.', dimensao: 'mudancas' },
    { id: 39, texto: 'As mudanças na organização são bem planejadas e comunicadas.', dimensao: 'mudancas' }
];

const ESCALA = [
    { valor: 1, label: 'Nunca' },
    { valor: 2, label: 'Raramente' },
    { valor: 3, label: 'Às vezes' },
    { valor: 4, label: 'Frequentemente' },
    { valor: 5, label: 'Sempre' }
];

const RECOMENDACOES = {
    'Demandas do Trabalho': ['Realizar análise da distribuição de tarefas e carga de trabalho', 'Implementar pausas programadas durante a jornada', 'Estabelecer priorização clara de tarefas e metas realistas', 'Revisar processos para eliminar retrabalhos'],
    'Controle/Autonomia': ['Aumentar participação dos trabalhadores em decisões', 'Implementar programa de sugestões e melhorias', 'Flexibilizar métodos de trabalho quando possível', 'Proporcionar maior autonomia na organização das tarefas'],
    'Apoio da Gestão': ['Capacitar lideranças em gestão de pessoas', 'Implementar reuniões periódicas de feedback', 'Criar canais de comunicação abertos com a gestão', 'Desenvolver programa de reconhecimento'],
    'Apoio dos Colegas': ['Promover atividades de integração entre equipes', 'Implementar trabalho colaborativo em projetos', 'Criar espaços para interação social', 'Desenvolver programa de mentoria entre pares'],
    'Relacionamentos': ['Implementar política de prevenção ao assédio (NR-5)', 'Criar canal de denúncias confidencial', 'Realizar treinamentos sobre respeito e diversidade', 'Estabelecer procedimentos para resolução de conflitos'],
    'Clareza de Função': ['Revisar e atualizar descrições de cargo', 'Comunicar claramente expectativas e responsabilidades', 'Definir indicadores de desempenho objetivos', 'Realizar reuniões de alinhamento periódicas'],
    'Gestão de Mudanças': ['Melhorar comunicação sobre mudanças organizacionais', 'Envolver trabalhadores no planejamento de mudanças', 'Oferecer suporte durante períodos de transição', 'Realizar avaliações de impacto antes de mudanças']
};

// ============================================================================
// ESTADO DA APLICAÇÃO
// ============================================================================

let dados = {
    empresa: {},
    participantes: [],
    resultados: null
};

let historico = [];
let questaoAtualIndex = 0;
let respostasAtuais = {};
let graficoBarras = null;
let graficoRadar = null;

// ============================================================================
// FUNÇÕES DE NAVEGAÇÃO
// ============================================================================

function mostrarTela(tela) {
    document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
    document.getElementById('tela-' + tela).classList.remove('hidden');
    window.scrollTo(0, 0);
    
    if (tela === 'historico') {
        carregarHistorico();
    }
}

// ============================================================================
// FUNÇÕES DE EMPRESA
// ============================================================================

function salvarEmpresa() {
    const nome = document.getElementById('empresa-nome').value.trim();
    const setor = document.getElementById('empresa-setor').value.trim();
    const dataInput = document.getElementById('empresa-data').value;
    
    if (!nome || !setor) {
        alert('Por favor, preencha o nome da empresa e o setor.');
        return;
    }
    
    if (!dataInput) {
        alert('Por favor, preencha a data da avaliação.');
        return;
    }
    
    dados.empresa = {
        nome: nome,
        cnpj: document.getElementById('empresa-cnpj').value.trim(),
        setor: setor,
        responsavel: document.getElementById('empresa-responsavel').value.trim(),
        funcao: document.getElementById('empresa-funcao').value.trim(),
        registro: document.getElementById('empresa-registro').value.trim(),
        data: dataInput
    };
    
    salvarDados();
    atualizarTelaParticipantes();
    mostrarTela('participantes');
}

function formatarData(dataISO) {
    if (!dataISO) return '';
    const partes = dataISO.split('-');
    if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    return dataISO;
}

// ============================================================================
// FUNÇÕES DE PARTICIPANTES
// ============================================================================

function atualizarTelaParticipantes() {
    document.getElementById('info-empresa').textContent = dados.empresa.nome;
    document.getElementById('info-setor').textContent = dados.empresa.setor;
    
    const lista = document.getElementById('lista-participantes');
    
    if (dados.participantes.length === 0) {
        lista.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum participante registrado.</p>';
    } else {
        lista.innerHTML = dados.participantes.map((p, i) => `
            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 mb-2">
                <div class="flex items-center">
                    <span class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-semibold mr-4">${i + 1}</span>
                    <div>
                        <p class="font-semibold text-gray-800">Participante ${i + 1}</p>
                        <p class="text-sm text-gray-500">${p.dataHora}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-green-600"><i class="fas fa-check-circle"></i> Concluído</span>
                    <button onclick="removerParticipante(${i})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    document.getElementById('btn-resultados').disabled = dados.participantes.length === 0;
}

function removerParticipante(index) {
    if (confirm('Remover este participante?')) {
        dados.participantes.splice(index, 1);
        salvarDados();
        atualizarTelaParticipantes();
    }
}

// ============================================================================
// FUNÇÕES DO QUESTIONÁRIO
// ============================================================================

function iniciarQuestionario() {
    questaoAtualIndex = 0;
    respostasAtuais = {};
    mostrarTela('questionario');
    renderizarQuestao();
}

function renderizarQuestao() {
    const questao = QUESTOES[questaoAtualIndex];
    const dimensao = DIMENSOES[questao.dimensao];
    
    const progresso = ((questaoAtualIndex + 1) / QUESTOES.length) * 100;
    document.getElementById('questao-atual').textContent = questaoAtualIndex + 1;
    document.getElementById('progresso-pct').textContent = Math.round(progresso);
    document.getElementById('barra-progresso').style.width = progresso + '%';
    
    const badge = document.getElementById('dimensao-badge');
    badge.textContent = dimensao.nome;
    badge.style.backgroundColor = dimensao.cor + '20';
    badge.style.color = dimensao.cor;
    
    document.getElementById('questao-texto').innerHTML = `<strong class="text-blue-600">${questao.id}.</strong> ${questao.texto}`;
    
    const opcoesDiv = document.getElementById('opcoes-resposta');
    opcoesDiv.innerHTML = ESCALA.map(e => `
        <button onclick="responder(${e.valor})" class="w-full p-4 rounded-lg border-2 transition text-left flex items-center gap-3 ${respostasAtuais[questao.id] === e.valor ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}">
            <span class="w-10 h-10 rounded-full flex items-center justify-center font-semibold ${respostasAtuais[questao.id] === e.valor ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'}">${e.valor}</span>
            <span class="text-gray-700">${e.label}</span>
        </button>
    `).join('');
    
    document.getElementById('btn-anterior').classList.toggle('hidden', questaoAtualIndex === 0);
    
    const todasRespondidas = Object.keys(respostasAtuais).length === QUESTOES.length;
    document.getElementById('btn-finalizar').classList.toggle('hidden', !todasRespondidas || questaoAtualIndex !== QUESTOES.length - 1);
}

function responder(valor) {
    const questao = QUESTOES[questaoAtualIndex];
    respostasAtuais[questao.id] = valor;
    
    if (questaoAtualIndex < QUESTOES.length - 1) {
        questaoAtualIndex++;
        renderizarQuestao();
    } else {
        renderizarQuestao();
    }
}

function questaoAnterior() {
    if (questaoAtualIndex > 0) {
        questaoAtualIndex--;
        renderizarQuestao();
    }
}

function finalizarQuestionario() {
    if (Object.keys(respostasAtuais).length < QUESTOES.length) {
        alert('Por favor, responda todas as questões.');
        return;
    }
    
    dados.participantes.push({
        respostas: { ...respostasAtuais },
        dataHora: new Date().toLocaleString('pt-BR')
    });
    
    salvarDados();
    atualizarTelaParticipantes();
    mostrarTela('participantes');
}

// ============================================================================
// FUNÇÕES DE CÁLCULO E RESULTADOS
// ============================================================================

function getNivelRisco(escore) {
    if (escore < 25) return { nivel: 'CRÍTICO', cor: '#e74c3c', bg: '#fadbd8', classe: 'nivel-critico', acao: 'Intervenção imediata necessária', prazo: '30 dias' };
    if (escore < 50) return { nivel: 'ALTO', cor: '#e67e22', bg: '#fdebd0', classe: 'nivel-alto', acao: 'Ação prioritária recomendada', prazo: '90 dias' };
    if (escore < 75) return { nivel: 'MODERADO', cor: '#f1c40f', bg: '#fcf3cf', classe: 'nivel-moderado', acao: 'Monitoramento e melhorias', prazo: '180 dias' };
    return { nivel: 'BAIXO', cor: '#27ae60', bg: '#d5f5e3', classe: 'nivel-baixo', acao: 'Manter práticas atuais', prazo: 'Contínuo' };
}

function calcularResultados() {
    const resultados = { dimensoes: {} };
    
    Object.entries(DIMENSOES).forEach(([key, dim]) => {
        let soma = 0, count = 0;
        
        dados.participantes.forEach(p => {
            dim.questoes.forEach(qId => {
                if (p.respostas[qId]) {
                    soma += p.respostas[qId];
                    count++;
                }
            });
        });
        
        const media = count > 0 ? soma / count : 0;
        let escore = dim.invertida ? 100 - ((media - 1) / 4 * 100) : ((media - 1) / 4 * 100);
        escore = Math.max(0, Math.min(100, escore));
        
        resultados.dimensoes[key] = {
            ...dim,
            media: media.toFixed(2),
            escore: escore.toFixed(1),
            risco: getNivelRisco(escore)
        };
    });
    
    const escoreGeral = Object.values(resultados.dimensoes).reduce((acc, d) => acc + parseFloat(d.escore), 0) / 7;
    resultados.escoreGeral = escoreGeral.toFixed(1);
    resultados.riscoGeral = getNivelRisco(escoreGeral);
    resultados.nParticipantes = dados.participantes.length;
    
    return resultados;
}

function verResultados() {
    if (dados.participantes.length === 0) {
        alert('Nenhum participante registrado.');
        return;
    }
    
    dados.resultados = calcularResultados();
    renderizarResultados();
    mostrarTela('resultados');
}

function renderizarResultados() {
    const r = dados.resultados;
    
    document.getElementById('dados-avaliacao').innerHTML = `
        <div><strong>Empresa:</strong> ${dados.empresa.nome}</div>
        <div><strong>Setor:</strong> ${dados.empresa.setor}</div>
        <div><strong>CNPJ:</strong> ${dados.empresa.cnpj || 'Não informado'}</div>
        <div><strong>Data:</strong> ${formatarData(dados.empresa.data)}</div>
        <div><strong>Participantes:</strong> ${r.nParticipantes}</div>
        ${dados.empresa.responsavel ? `<div><strong>Resp. Técnico:</strong> ${dados.empresa.responsavel}</div>` : ''}
        ${dados.empresa.funcao ? `<div><strong>Função:</strong> ${dados.empresa.funcao}</div>` : ''}
        ${dados.empresa.registro ? `<div><strong>Registro:</strong> ${dados.empresa.registro}</div>` : ''}
    `;
    
    const criticas = Object.values(r.dimensoes).filter(d => d.risco.nivel === 'CRÍTICO');
    const altas = Object.values(r.dimensoes).filter(d => d.risco.nivel === 'ALTO');
    
    let alertasHTML = '';
    if (criticas.length > 0) {
        alertasHTML += `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><div class="flex items-center gap-2 text-red-700 font-semibold"><i class="fas fa-exclamation-triangle"></i> ${criticas.length} dimensão(ões) CRÍTICO</div></div>`;
    }
    if (altas.length > 0) {
        alertasHTML += `<div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mt-2"><div class="flex items-center gap-2 text-orange-700 font-semibold"><i class="fas fa-exclamation-circle"></i> ${altas.length} dimensão(ões) ALTO</div></div>`;
    }
    
    document.getElementById('resultado-geral').innerHTML = `
        <div class="text-center p-8 rounded-xl flex-1" style="background-color: ${r.riscoGeral.bg}">
            <div class="text-5xl font-bold mb-2" style="color: ${r.riscoGeral.cor}">${r.escoreGeral}</div>
            <div class="text-gray-600">Escore Geral (0-100)</div>
            <span class="mt-3 inline-block px-6 py-2 rounded-full text-white font-semibold text-lg" style="background-color: ${r.riscoGeral.cor}">${r.riscoGeral.nivel}</span>
            <p class="mt-3 text-sm text-gray-600">${r.riscoGeral.acao}</p>
        </div>
        ${alertasHTML ? `<div class="flex-1">${alertasHTML}</div>` : ''}
    `;
    
    document.getElementById('tbody-resultados').innerHTML = Object.values(r.dimensoes).map(dim => `
        <tr style="background-color: ${dim.risco.bg}">
            <td class="p-4 font-medium">
                <span class="w-3 h-3 rounded-full inline-block mr-2" style="background-color: ${dim.cor}"></span>
                ${dim.nome}
            </td>
            <td class="p-4 text-center font-bold text-lg">${dim.escore}</td>
            <td class="p-4 text-center">
                <span class="px-3 py-1 rounded-full text-white text-xs font-semibold" style="background-color: ${dim.risco.cor}">${dim.risco.nivel}</span>
            </td>
            <td class="p-4">${dim.risco.acao}</td>
        </tr>
    `).join('');
    
    const problematicas = Object.values(r.dimensoes).filter(d => ['CRÍTICO', 'ALTO'].includes(d.risco.nivel));
    if (problematicas.length > 0) {
        document.getElementById('plano-acao').innerHTML = `
            <h2 class="font-bold text-gray-800 mb-4"><i class="fas fa-tasks mr-2 text-blue-600"></i> Plano de Ação Recomendado</h2>
            ${problematicas.map(dim => `
                <div class="mb-6 last:mb-0 p-4 rounded-lg" style="background-color: ${dim.risco.bg}">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <span class="px-3 py-1 rounded-full text-white text-sm mr-2" style="background-color: ${dim.risco.cor}">${dim.risco.nivel}</span>
                        ${dim.nome} (Escore: ${dim.escore})
                    </h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        ${(RECOMENDACOES[dim.nome] || []).map(rec => `<li><i class="fas fa-check-circle text-green-500 mr-2"></i>${rec}</li>`).join('')}
                    </ul>
                </div>
            `).join('')}
        `;
    } else {
        document.getElementById('plano-acao').innerHTML = `
            <h2 class="font-bold text-gray-800 mb-4"><i class="fas fa-tasks mr-2 text-blue-600"></i> Plano de Ação</h2>
            <p class="text-green-700 bg-green-50 p-4 rounded-lg">
                <i class="fas fa-check-circle mr-2"></i>
                Nenhuma dimensão em nível crítico ou alto. Recomenda-se manter as práticas atuais e monitoramento contínuo.
            </p>
        `;
    }
    
    renderizarGraficos();
}

function renderizarGraficos() {
    const r = dados.resultados;
    const dimensoes = Object.values(r.dimensoes);
    
    if (graficoBarras) graficoBarras.destroy();
    if (graficoRadar) graficoRadar.destroy();
    
    const ctxBarras = document.getElementById('grafico-barras').getContext('2d');
    graficoBarras = new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: dimensoes.map(d => d.nome),
            datasets: [{
                label: 'Escore',
                data: dimensoes.map(d => parseFloat(d.escore)),
                backgroundColor: dimensoes.map(d => d.risco.cor + '80'),
                borderColor: dimensoes.map(d => d.risco.cor),
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { min: 0, max: 100 } },
            plugins: { legend: { display: false } }
        }
    });
    
    const ctxRadar = document.getElementById('grafico-radar').getContext('2d');
    graficoRadar = new Chart(ctxRadar, {
        type: 'radar',
        data: {
            labels: dimensoes.map(d => d.nome.split(' ')[0]),
            datasets: [{
                label: 'Escore',
                data: dimensoes.map(d => parseFloat(d.escore)),
                backgroundColor: 'rgba(40, 116, 166, 0.3)',
                borderColor: '#2874a6',
                borderWidth: 2,
                pointBackgroundColor: '#2874a6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { min: 0, max: 100 } }
        }
    });
}

// ============================================================================
// FUNÇÕES DE HISTÓRICO
// ============================================================================

function carregarHistorico() {
    const saved = localStorage.getItem('historicoAvaliacoes');
    historico = saved ? JSON.parse(saved) : [];
    
    // Preencher filtro de empresas
    const empresas = [...new Set(historico.map(h => h.empresa.nome))];
    const select = document.getElementById('filtro-empresa');
    select.innerHTML = '<option value="">Todas as empresas</option>' +
        empresas.map(e => `<option value="${e}">${e}</option>`).join('');
    
    filtrarHistorico();
}

function filtrarHistorico() {
    const filtro = document.getElementById('filtro-empresa').value;
    const itens = filtro ? historico.filter(h => h.empresa.nome === filtro) : historico;
    
    const lista = document.getElementById('lista-historico');
    
    if (itens.length === 0) {
        lista.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">Nenhuma avaliação salva no histórico.</p>
            </div>
        `;
        return;
    }
    
    lista.innerHTML = itens.map((item, index) => `
        <div class="bg-gray-50 rounded-xl p-4 mb-4 border">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">${item.empresa.nome}</h3>
                    <p class="text-gray-600 text-sm">
                        <i class="fas fa-industry mr-1"></i> ${item.empresa.setor}
                        <span class="mx-2">|</span>
                        <i class="fas fa-calendar mr-1"></i> ${formatarData(item.empresa.data)}
                        <span class="mx-2">|</span>
                        <i class="fas fa-users mr-1"></i> ${item.resultados.nParticipantes} participante(s)
                    </p>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold" style="color: ${item.resultados.riscoGeral.cor}">${item.resultados.escoreGeral}</div>
                    <span class="px-3 py-1 rounded-full text-white text-xs font-semibold" style="background-color: ${item.resultados.riscoGeral.cor}">
                        ${item.resultados.riscoGeral.nivel}
                    </span>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="carregarDoHistorico(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-eye mr-1"></i> Ver
                </button>
                <button onclick="gerarPDFDoHistorico(${index})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-file-pdf mr-1"></i> PDF
                </button>
                <button onclick="removerDoHistorico(${index})" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">
                    <i class="fas fa-trash mr-1"></i> Excluir
                </button>
            </div>
        </div>
    `).join('');
}

function salvarNoHistorico() {
    const item = {
        id: Date.now(),
        empresa: { ...dados.empresa },
        participantes: [...dados.participantes],
        resultados: { ...dados.resultados },
        dataSalvamento: new Date().toLocaleString('pt-BR')
    };
    
    historico.unshift(item);
    localStorage.setItem('historicoAvaliacoes', JSON.stringify(historico));
    
    alert('Avaliação salva no histórico com sucesso!');
}

function carregarDoHistorico(index) {
    const item = historico[index];
    dados.empresa = { ...item.empresa };
    dados.participantes = [...item.participantes];
    dados.resultados = { ...item.resultados };
    
    // Preencher campos
    document.getElementById('empresa-nome').value = dados.empresa.nome;
    document.getElementById('empresa-cnpj').value = dados.empresa.cnpj || '';
    document.getElementById('empresa-setor').value = dados.empresa.setor;
    document.getElementById('empresa-responsavel').value = dados.empresa.responsavel || '';
    document.getElementById('empresa-funcao').value = dados.empresa.funcao || '';
    document.getElementById('empresa-registro').value = dados.empresa.registro || '';
    document.getElementById('empresa-data').value = dados.empresa.data;
    
    renderizarResultados();
    mostrarTela('resultados');
}

function gerarPDFDoHistorico(index) {
    const item = historico[index];
    dados.empresa = { ...item.empresa };
    dados.participantes = [...item.participantes];
    dados.resultados = { ...item.resultados };
    gerarPDF();
}

function removerDoHistorico(index) {
    if (confirm('Tem certeza que deseja excluir esta avaliação do histórico?')) {
        historico.splice(index, 1);
        localStorage.setItem('historicoAvaliacoes', JSON.stringify(historico));
        filtrarHistorico();
    }
}

// ============================================================================
// FUNÇÕES DE EXPORTAÇÃO PDF
// ============================================================================

function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const r = dados.resultados;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
    // Função para adicionar rodapé
    function addFooter(pageNum) {
        doc.setFontSize(8);
        doc.setTextColor(128);
        doc.text('© 2025 RC Engenharia - Serviços de Segurança e Saúde Ocupacional. Todos os direitos reservados.', pageWidth / 2, pageHeight - 10, { align: 'center' });
        doc.text(`Página ${pageNum}`, pageWidth - 20, pageHeight - 10);
    }
    
    let pageNum = 1;
    
    // ===== PÁGINA 1: CAPA =====
    doc.setFillColor(30, 58, 138);
    doc.rect(0, 0, pageWidth, 50, 'F');
    
    doc.setFontSize(18);
    doc.setTextColor(255);
    doc.text('RELATÓRIO DE AVALIAÇÃO', pageWidth / 2, 25, { align: 'center' });
    doc.text('RISCOS PSICOSSOCIAIS', pageWidth / 2, 35, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setTextColor(200);
    doc.text('Conforme NR-1 (GRO) e NR-17 (Ergonomia) - Portaria MTE nº 1.419/2024', pageWidth / 2, 45, { align: 'center' });
    
    // Dados da empresa
    doc.setTextColor(0);
    doc.setFontSize(12);
    doc.text('DADOS DA AVALIAÇÃO', 14, 70);
    
    doc.setFontSize(10);
    let y = 82;
    const lineHeight = 8;
    
    doc.setFont('helvetica', 'bold');
    doc.text('Empresa:', 14, y);
    doc.setFont('helvetica', 'normal');
    doc.text(dados.empresa.nome, 45, y);
    y += lineHeight;
    
    doc.setFont('helvetica', 'bold');
    doc.text('CNPJ:', 14, y);
    doc.setFont('helvetica', 'normal');
    doc.text(dados.empresa.cnpj || 'Não informado', 45, y);
    y += lineHeight;
    
    doc.setFont('helvetica', 'bold');
    doc.text('Setor:', 14, y);
    doc.setFont('helvetica', 'normal');
    doc.text(dados.empresa.setor, 45, y);
    y += lineHeight;
    
    doc.setFont('helvetica', 'bold');
    doc.text('Data:', 14, y);
    doc.setFont('helvetica', 'normal');
    doc.text(formatarData(dados.empresa.data), 45, y);
    y += lineHeight;
    
    doc.setFont('helvetica', 'bold');
    doc.text('Participantes:', 14, y);
    doc.setFont('helvetica', 'normal');
    doc.text(String(r.nParticipantes), 45, y);
    y += lineHeight;
    
    if (dados.empresa.responsavel) {
        doc.setFont('helvetica', 'bold');
        doc.text('Resp. Técnico:', 14, y);
        doc.setFont('helvetica', 'normal');
        doc.text(dados.empresa.responsavel, 45, y);
        y += lineHeight;
    }
    
    if (dados.empresa.funcao) {
        doc.setFont('helvetica', 'bold');
        doc.text('Função:', 14, y);
        doc.setFont('helvetica', 'normal');
        doc.text(dados.empresa.funcao, 45, y);
        y += lineHeight;
    }
    
    if (dados.empresa.registro) {
        doc.setFont('helvetica', 'bold');
        doc.text('Registro:', 14, y);
        doc.setFont('helvetica', 'normal');
        doc.text(dados.empresa.registro, 45, y);
        y += lineHeight;
    }
    
    // Resultado Geral
    y += 10;
    doc.setFontSize(12);
    doc.text('RESULTADO GERAL', 14, y);
    y += 12;
    
    // Box do resultado
    const nivelCor = r.riscoGeral.cor;
    doc.setFillColor(parseInt(nivelCor.slice(1,3),16), parseInt(nivelCor.slice(3,5),16), parseInt(nivelCor.slice(5,7),16));
    doc.roundedRect(14, y, 80, 35, 3, 3, 'F');
    
    doc.setFontSize(28);
    doc.setTextColor(255);
    doc.text(r.escoreGeral, 54, y + 18, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(r.riscoGeral.nivel, 54, y + 28, { align: 'center' });
    
    doc.setTextColor(0);
    doc.setFontSize(10);
    doc.text(r.riscoGeral.acao, 100, y + 15);
    doc.text(`Prazo: ${r.riscoGeral.prazo}`, 100, y + 23);
    
    addFooter(pageNum);
    
    // ===== PÁGINA 2: RESULTADOS POR DIMENSÃO =====
    doc.addPage();
    pageNum++;
    
    doc.setFontSize(14);
    doc.setTextColor(30, 58, 138);
    doc.text('RESULTADOS POR DIMENSÃO', 14, 20);
    
    const tableData = Object.values(r.dimensoes).map(dim => [
        dim.nome,
        dim.escore,
        dim.risco.nivel,
        dim.risco.acao
    ]);
    
    doc.autoTable({
        startY: 30,
        head: [['Dimensão', 'Escore', 'Nível', 'Ação Recomendada']],
        body: tableData,
        headStyles: { fillColor: [30, 58, 138], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 9, cellPadding: 4 },
        columnStyles: {
            0: { cellWidth: 50 },
            1: { cellWidth: 20, halign: 'center' },
            2: { cellWidth: 25, halign: 'center' },
            3: { cellWidth: 'auto' }
        },
        didParseCell: function(data) {
            if (data.section === 'body' && data.column.index === 2) {
                const nivel = data.cell.raw;
                if (nivel === 'CRÍTICO') data.cell.styles.fillColor = [250, 219, 216];
                else if (nivel === 'ALTO') data.cell.styles.fillColor = [253, 235, 208];
                else if (nivel === 'MODERADO') data.cell.styles.fillColor = [252, 243, 207];
                else data.cell.styles.fillColor = [213, 245, 227];
            }
        }
    });
    
    // Legenda
    let legendaY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(10);
    doc.text('Classificação de Risco:', 14, legendaY);
    legendaY += 8;
    
    const legendas = [
        { nivel: 'CRÍTICO', cor: [231, 76, 60], desc: '0-24 pontos' },
        { nivel: 'ALTO', cor: [230, 126, 34], desc: '25-49 pontos' },
        { nivel: 'MODERADO', cor: [241, 196, 15], desc: '50-74 pontos' },
        { nivel: 'BAIXO', cor: [39, 174, 96], desc: '75-100 pontos' }
    ];
    
    legendas.forEach((leg, i) => {
        doc.setFillColor(...leg.cor);
        doc.rect(14 + (i * 45), legendaY, 8, 8, 'F');
        doc.setFontSize(8);
        doc.text(`${leg.nivel} (${leg.desc})`, 24 + (i * 45), legendaY + 6);
    });
    
    addFooter(pageNum);
    
    // ===== PÁGINA 3: PLANO DE AÇÃO =====
    doc.addPage();
    pageNum++;
    
    doc.setFontSize(14);
    doc.setTextColor(30, 58, 138);
    doc.text('PLANO DE AÇÃO RECOMENDADO', 14, 20);
    
    let yPos = 35;
    const problematicas = Object.values(r.dimensoes).filter(d => ['CRÍTICO', 'ALTO'].includes(d.risco.nivel));
    
    if (problematicas.length > 0) {
        problematicas.forEach(dim => {
            // Título da dimensão
            const nivelCorDim = dim.risco.cor;
            doc.setFillColor(parseInt(nivelCorDim.slice(1,3),16), parseInt(nivelCorDim.slice(3,5),16), parseInt(nivelCorDim.slice(5,7),16));
            doc.roundedRect(14, yPos - 5, 30, 8, 2, 2, 'F');
            
            doc.setFontSize(9);
            doc.setTextColor(255);
            doc.text(dim.risco.nivel, 29, yPos, { align: 'center' });
            
            doc.setTextColor(0);
            doc.setFontSize(11);
            doc.text(`${dim.nome} (Escore: ${dim.escore})`, 48, yPos);
            yPos += 10;
            
            // Recomendações
            doc.setFontSize(9);
            (RECOMENDACOES[dim.nome] || []).forEach(rec => {
                doc.text(`• ${rec}`, 18, yPos);
                yPos += 6;
            });
            
            yPos += 8;
            
            if (yPos > 250) {
                addFooter(pageNum);
                doc.addPage();
                pageNum++;
                yPos = 20;
            }
        });
    } else {
        doc.setFontSize(10);
        doc.text('Nenhuma dimensão em nível crítico ou alto. Manter práticas atuais.', 14, yPos);
    }
    
    // Cronograma
    yPos += 15;
    if (yPos > 200) {
        addFooter(pageNum);
        doc.addPage();
        pageNum++;
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setTextColor(30, 58, 138);
    doc.text('CRONOGRAMA SUGERIDO', 14, yPos);
    yPos += 10;
    
    const cronograma = [
        ['IMEDIATA', 'Até 30 dias', 'Dimensões em nível CRÍTICO'],
        ['ALTA', 'Até 90 dias', 'Dimensões em nível ALTO'],
        ['MÉDIA', 'Até 180 dias', 'Dimensões em nível MODERADO'],
        ['CONTÍNUA', 'Permanente', 'Monitoramento e melhoria']
    ];
    
    doc.autoTable({
        startY: yPos,
        head: [['Prioridade', 'Prazo', 'Ações']],
        body: cronograma,
        headStyles: { fillColor: [30, 58, 138] },
        styles: { fontSize: 9 }
    });
    
    addFooter(pageNum);
    
    // ===== PÁGINA 4: REFERÊNCIAS E ASSINATURA =====
    doc.addPage();
    pageNum++;
    
    doc.setFontSize(14);
    doc.setTextColor(30, 58, 138);
    doc.text('REFERÊNCIAS NORMATIVAS', 14, 20);
    
    doc.setFontSize(9);
    doc.setTextColor(0);
    const refs = [
        '• BRASIL. MTE. NR-1 - Disposições Gerais e GRO. Portaria MTE nº 1.419/2024.',
        '• BRASIL. MTE. NR-17 - Ergonomia.',
        '• BRASIL. MTE. Guia sobre Fatores de Riscos Psicossociais. 2025.',
        '• HSE. Managing the causes of work-related stress. London, 2007.',
        '• ISO 45003:2021 - Psychological health and safety at work.',
        '• KARASEK, R.A.; THEORELL, T. Healthy work. Basic Books, 1990.',
        '• OIT. Psychosocial factors at work. Geneva, 1986.',
        '• CFP. Resolução nº 14/2023 - Avaliação psicossocial.'
    ];
    
    let refY = 35;
    refs.forEach(ref => {
        doc.text(ref, 14, refY);
        refY += 6;
    });
    
    // Assinatura
    refY += 30;
    doc.setDrawColor(0);
    doc.line(14, refY, 100, refY);
    refY += 5;
    
    doc.setFontSize(10);
    if (dados.empresa.responsavel) {
        doc.text(dados.empresa.responsavel, 14, refY);
        refY += 5;
    }
    if (dados.empresa.funcao) {
        doc.text(dados.empresa.funcao, 14, refY);
        refY += 5;
    }
    if (dados.empresa.registro) {
        doc.text(`Registro: ${dados.empresa.registro}`, 14, refY);
        refY += 5;
    }
    doc.text(`Data: ${formatarData(dados.empresa.data)}`, 14, refY);
    
    addFooter(pageNum);
    
    // Salvar PDF
    const nomeArquivo = `Relatorio_Riscos_Psicossociais_${dados.empresa.nome.replace(/\s+/g, '_').replace(/[^\w]/g, '')}_${dados.empresa.data}.pdf`;
    doc.save(nomeArquivo);
}

// ============================================================================
// FUNÇÕES DE EXPORTAÇÃO EXCEL
// ============================================================================

function exportarExcel() {
    const r = dados.resultados;
    const wb = XLSX.utils.book_new();
    
    // Aba Resumo
    const resumoData = [
        ['AVALIAÇÃO DE RISCOS PSICOSSOCIAIS'],
        ['RC Engenharia - Serviços de Segurança e Saúde Ocupacional'],
        [''],
        ['DADOS DA AVALIAÇÃO'],
        ['Empresa:', dados.empresa.nome],
        ['CNPJ:', dados.empresa.cnpj || 'Não informado'],
        ['Setor:', dados.empresa.setor],
        ['Data:', formatarData(dados.empresa.data)],
        ['Participantes:', r.nParticipantes],
        ['Responsável Técnico:', dados.empresa.responsavel || ''],
        ['Função:', dados.empresa.funcao || ''],
        ['Registro:', dados.empresa.registro || ''],
        [''],
        ['RESULTADO GERAL'],
        ['Escore:', r.escoreGeral],
        ['Nível:', r.riscoGeral.nivel],
        ['Ação:', r.riscoGeral.acao],
        [''],
        ['RESULTADOS POR DIMENSÃO'],
        ['Dimensão', 'Escore', 'Nível', 'Ação Recomendada'],
        ...Object.values(r.dimensoes).map(d => [d.nome, d.escore, d.risco.nivel, d.risco.acao]),
        [''],
        ['© 2025 RC Engenharia - Todos os direitos reservados']
    ];
    const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
    XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');
    
    // Aba Respostas
    const respostasHeader = ['Participante', ...QUESTOES.map(q => `Q${q.id}`)];
    const respostasData = [
        respostasHeader,
        ...dados.participantes.map((p, i) => [
            `P${i + 1}`,
            ...QUESTOES.map(q => p.respostas[q.id] || '')
        ])
    ];
    const wsRespostas = XLSX.utils.aoa_to_sheet(respostasData);
    XLSX.utils.book_append_sheet(wb, wsRespostas, 'Respostas');
    
    // Aba Questões
    const questoesData = [
        ['ID', 'Dimensão', 'Questão'],
        ...QUESTOES.map(q => [q.id, DIMENSOES[q.dimensao].nome, q.texto])
    ];
    const wsQuestoes = XLSX.utils.aoa_to_sheet(questoesData);
    XLSX.utils.book_append_sheet(wb, wsQuestoes, 'Questionário');
    
    const nomeArquivo = `Dados_Riscos_Psicossociais_${dados.empresa.nome.replace(/\s+/g, '_').replace(/[^\w]/g, '')}_${dados.empresa.data}.xlsx`;
    XLSX.writeFile(wb, nomeArquivo);
}

// ============================================================================
// FUNÇÕES DE BACKUP
// ============================================================================

function exportarBackup() {
    const backup = {
        versao: '1.0',
        dataExportacao: new Date().toISOString(),
        dadosAtuais: dados,
        historico: historico
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_riscos_psicossociais_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('Backup exportado com sucesso!');
}

function importarBackup() {
    document.getElementById('input-backup').click();
}

function processarBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (backup.historico) {
                historico = backup.historico;
                localStorage.setItem('historicoAvaliacoes', JSON.stringify(historico));
            }
            
            if (backup.dadosAtuais) {
                dados = backup.dadosAtuais;
                salvarDados();
                
                // Preencher campos
                if (dados.empresa.nome) {
                    document.getElementById('empresa-nome').value = dados.empresa.nome;
                    document.getElementById('empresa-cnpj').value = dados.empresa.cnpj || '';
                    document.getElementById('empresa-setor').value = dados.empresa.setor;
                    document.getElementById('empresa-responsavel').value = dados.empresa.responsavel || '';
                    document.getElementById('empresa-funcao').value = dados.empresa.funcao || '';
                    document.getElementById('empresa-registro').value = dados.empresa.registro || '';
                    document.getElementById('empresa-data').value = dados.empresa.data;
                }
            }
            
            alert('Backup restaurado com sucesso!');
            mostrarTela('inicio');
        } catch (err) {
            alert('Erro ao ler o arquivo de backup. Verifique se o arquivo está correto.');
            console.error(err);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ============================================================================
// FUNÇÕES DE PERSISTÊNCIA
// ============================================================================

function salvarDados() {
    localStorage.setItem('riscosPsicossociais', JSON.stringify(dados));
}

function carregarDados() {
    const saved = localStorage.getItem('riscosPsicossociais');
    if (saved) {
        dados = JSON.parse(saved);
        
        if (dados.empresa.nome) {
            document.getElementById('empresa-nome').value = dados.empresa.nome;
            document.getElementById('empresa-cnpj').value = dados.empresa.cnpj || '';
            document.getElementById('empresa-setor').value = dados.empresa.setor;
            document.getElementById('empresa-responsavel').value = dados.empresa.responsavel || '';
            document.getElementById('empresa-funcao').value = dados.empresa.funcao || '';
            document.getElementById('empresa-registro').value = dados.empresa.registro || '';
            document.getElementById('empresa-data').value = dados.empresa.data;
        }
    }
    
    const savedHistorico = localStorage.getItem('historicoAvaliacoes');
    if (savedHistorico) {
        historico = JSON.parse(savedHistorico);
    }
}

// ============================================================================
// INICIALIZAÇÃO
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('empresa-data').value = new Date().toISOString().split('T')[0];
    carregarDados();
});
</script>

</body>
</html>
